<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Recruitment Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Country code to full name mapping
        const countryNames = {
            'US': 'United States',
            'GB': 'United Kingdom',
            'CA': 'Canada',
            'AU': 'Australia',
            'DE': 'Germany',
            'FR': 'France',
            'NL': 'Netherlands',
            'ES': 'Spain',
            'IT': 'Italy',
            'SE': 'Sweden',
            'NO': 'Norway',
            'DK': 'Denmark',
            'FI': 'Finland',
            'IE': 'Ireland',
            'BE': 'Belgium',
            'AT': 'Austria',
            'CH': 'Switzerland',
            'PL': 'Poland',
            'CZ': 'Czech Republic',
            'PT': 'Portugal',
            'GR': 'Greece',
            'RO': 'Romania',
            'HU': 'Hungary',
            'BG': 'Bulgaria',
            'HR': 'Croatia',
            'SK': 'Slovakia',
            'SI': 'Slovenia',
            'EE': 'Estonia',
            'LV': 'Latvia',
            'LT': 'Lithuania',
            'CY': 'Cyprus',
            'MT': 'Malta',
            'LU': 'Luxembourg',
            'JP': 'Japan',
            'CN': 'China',
            'IN': 'India',
            'KR': 'South Korea',
            'SG': 'Singapore',
            'HK': 'Hong Kong',
            'MY': 'Malaysia',
            'TH': 'Thailand',
            'ID': 'Indonesia',
            'PH': 'Philippines',
            'VN': 'Vietnam',
            'NZ': 'New Zealand',
            'BR': 'Brazil',
            'MX': 'Mexico',
            'AR': 'Argentina',
            'CL': 'Chile',
            'CO': 'Colombia',
            'PE': 'Peru',
            'ZA': 'South Africa',
            'NG': 'Nigeria',
            'KE': 'Kenya',
            'EG': 'Egypt',
            'AE': 'United Arab Emirates',
            'SA': 'Saudi Arabia',
            'IL': 'Israel',
            'TR': 'Turkey',
            'RU': 'Russia',
            'UA': 'Ukraine',
            'PK': 'Pakistan',
            'BD': 'Bangladesh'
        };

        const getFullCountryName = (code) => {
            return countryNames[code] || code;
        };

        // API Helper
        const callAPI = async (endpoint, data) => {
            try {
                const response = await fetch(`/.netlify/functions/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error(`Error calling ${endpoint}:`, error);
                throw error;
            }
        };

        // Export to CSV Function
        const exportToCSV = (bitlyData, eventsData, dateRange) => {
            if (!bitlyData && !eventsData) return;
            
            let csv = 'Student Recruitment Dashboard Report\n';
            csv += `Generated: ${new Date().toLocaleString()}\n`;
            csv += `Link Data Range: Last ${dateRange} days\n\n`;
            
            // Links
            if (bitlyData?.links) {
                csv += 'RECRUITMENT LINKS\n';
                csv += 'Link,Title,Clicks,Tags\n';
                bitlyData.links.forEach(link => {
                    const title = (link.title || link.id).replace(/"/g, '""');
                    const tags = (link.tags || []).join('; ');
                    csv += `"${link.id}","${title}",${link.clicks},"${tags}"\n`;
                });
                csv += '\n';
            }
            
            // Geography
            if (bitlyData?.topCountries) {
                csv += 'GEOGRAPHIC DISTRIBUTION\n';
                csv += 'Country,Clicks,Percentage\n';
                bitlyData.topCountries.forEach(country => {
                    const fullName = getFullCountryName(country.country);
                    csv += `"${fullName}",${country.clicks},${country.percentage}%\n`;
                });
                csv += '\n';
            }
            
            // Events
            if (eventsData?.upcomingEvents) {
                csv += 'UPCOMING EVENTS\n';
                csv += 'Date,Event Name,Venue,Attending\n';
                eventsData.upcomingEvents.forEach(event => {
                    const date = new Date(event.start).toLocaleDateString();
                    const name = event.name.replace(/"/g, '""');
                    const venue = (event.venue || 'TBA').replace(/"/g, '""');
                    csv += `"${date}","${name}","${venue}",${event.sold}\n`;
                });
            }
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `recruitment-dashboard-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        };

        // Referrer Modal Component
        const ReferrerModal = ({ link, onClose }) => {
            if (!link) return null;
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-auto" onClick={(e) => e.stopPropagation()}>
                        <div className="sticky top-0 bg-white border-b border-gray-200 p-6">
                            <div className="flex justify-between items-start">
                                <div className="flex-1 pr-4">
                                    <h3 className="text-2xl font-bold text-gray-900 mb-1">{link.title || 'Link Details'}</h3>
                                    <a href={link.shortUrl} target="_blank" rel="noopener noreferrer" 
                                       className="text-blue-600 hover:underline text-sm font-mono">
                                        {link.shortUrl}
                                    </a>
                                </div>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl leading-none">
                                    Ã—
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-6">
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div className="bg-blue-50 p-6 rounded-lg text-center">
                                    <div className="text-4xl font-bold text-blue-600 mb-2">{link.clicks}</div>
                                    <div className="text-sm text-gray-600 font-medium">Total Clicks</div>
                                </div>
                                <div className="bg-green-50 p-6 rounded-lg text-center">
                                    <div className="text-4xl font-bold text-green-600 mb-2">
                                        {link.countries?.length || 0}
                                    </div>
                                    <div className="text-sm text-gray-600 font-medium">Countries</div>
                                </div>
                            </div>

                            {link.referrers && link.referrers.length > 0 ? (
                                <div className="mb-6">
                                    <h4 className="font-bold text-gray-900 mb-4 text-lg">
                                        <i className="fas fa-share-alt mr-2 text-blue-600"></i>
                                        Traffic Sources
                                    </h4>
                                    <div className="space-y-3">
                                        {link.referrers.map((ref, idx) => {
                                            const percentage = ((ref.clicks / link.clicks) * 100).toFixed(1);
                                            return (
                                                <div key={idx} className="flex items-center gap-4 p-3 bg-gray-50 rounded-lg">
                                                    <div className="flex-1">
                                                        <div className="font-medium text-gray-900 mb-1">{ref.value}</div>
                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                            <div className="bg-blue-600 h-2 rounded-full transition-all"
                                                                 style={{ width: `${percentage}%` }}></div>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-gray-900 text-lg">{ref.clicks}</div>
                                                        <div className="text-xs text-gray-500">{percentage}%</div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ) : (
                                <div className="mb-6 text-center py-8 bg-gray-50 rounded-lg">
                                    <i className="fas fa-share-alt text-4xl mb-3 text-gray-300"></i>
                                    <p className="text-gray-500 font-medium">No referrer data available for this link</p>
                                </div>
                            )}

                            {link.countries && link.countries.length > 0 && (
                                <div>
                                    <h4 className="font-bold text-gray-900 mb-4 text-lg">
                                        <i className="fas fa-globe mr-2 text-green-600"></i>
                                        Top Countries
                                    </h4>
                                    <div className="grid grid-cols-2 gap-3">
                                        {link.countries.slice(0, 6).map((country, idx) => (
                                            <div key={idx} className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <span className="font-medium text-gray-700">{getFullCountryName(country.value)}</span>
                                                <span className="font-bold text-gray-900">{country.clicks}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // KPI Card Component
        const KPICard = ({ title, value, change, icon, color, loading, subtitle }) => {
            const isPositive = change >= 0;
            return (
                <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <div className="flex items-center justify-between">
                        <div className="flex-1">
                            <p className="text-gray-500 text-sm font-medium uppercase tracking-wide">{title}</p>
                            {loading ? (
                                <div className="animate-pulse mt-2">
                                    <div className="h-8 bg-gray-200 rounded w-24"></div>
                                </div>
                            ) : (
                                <>
                                    <p className="text-3xl font-bold text-gray-900 mt-2">{value}</p>
                                    {subtitle && <p className="text-xs text-gray-500 mt-1">{subtitle}</p>}
                                    {change !== null && change !== undefined && (
                                        <p className={`text-sm mt-2 font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
                                            <i className={`fas fa-arrow-${isPositive ? 'up' : 'down'} mr-1`}></i>
                                            {Math.abs(change)}% vs last week
                                        </p>
                                    )}
                                </>
                            )}
                        </div>
                        <div className={`${color} p-4 rounded-full shadow-md`}>
                            <i className={`${icon} text-2xl text-white`}></i>
                        </div>
                    </div>
                </div>
            );
        };

        // Chart Component
        const ChartComponent = ({ title, type, data, labels, loading, height = 300 }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current && !loading && data && labels) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: type,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: title,
                                data: data,
                                backgroundColor: type === 'line' ? 'rgba(59, 130, 246, 0.1)' : [
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(236, 72, 153, 0.8)',
                                    'rgba(99, 102, 241, 0.8)',
                                    'rgba(251, 146, 60, 0.8)'
                                ],
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                fill: type === 'line',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: type !== 'line',
                                    position: 'bottom'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: type === 'line' || type === 'bar' ? {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            } : {}
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, labels, type, title, loading]);

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                    {loading ? (
                        <div className="animate-pulse" style={{ height: `${height}px` }}>
                            <div className="h-full bg-gray-200 rounded"></div>
                        </div>
                    ) : (
                        <div style={{ height: `${height}px` }}>
                            <canvas ref={chartRef}></canvas>
                        </div>
                    )}
                </div>
            );
        };

        // Events Table Component
        const EventsTable = ({ events, loading }) => {
            const [sortField, setSortField] = useState('start');
            const [sortDirection, setSortDirection] = useState('asc');

            const sortedEvents = events ? [...events].sort((a, b) => {
                const aVal = a[sortField];
                const bVal = b[sortField];
                const modifier = sortDirection === 'asc' ? 1 : -1;
                return aVal > bVal ? modifier : -modifier;
            }) : [];

            const toggleSort = (field) => {
                if (sortField === field) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortDirection('asc');
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">
                        <i className="fas fa-calendar-alt mr-2"></i>Upcoming Events
                    </h3>
                    {loading ? (
                        <div className="animate-pulse space-y-3">
                            {[1,2,3,4,5].map(i => (
                                <div key={i} className="h-16 bg-gray-200 rounded"></div>
                            ))}
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('start')}>
                                            Date {sortField === 'start' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('name')}>
                                            Event Name {sortField === 'name' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Venue</th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('sold')}>
                                            Attending {sortField === 'sold' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {sortedEvents.map((event, index) => {
                                        const date = new Date(event.start);
                                        
                                        return (
                                            <tr key={index} className="hover:bg-gray-50">
                                                <td className="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">
                                                    {date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}
                                                </td>
                                                <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                    {event.name}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-600">
                                                    {event.venue || 'TBA'}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-900 text-right font-semibold">
                                                    {event.sold}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Links Table Component
        const LinksTable = ({ links, loading, onViewDetails }) => {
            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">
                        <i className="fas fa-link mr-2"></i>Student Recruitment Links
                    </h3>
                    {loading ? (
                        <div className="animate-pulse space-y-3">
                            {[1,2,3,4,5].map(i => (
                                <div key={i} className="h-12 bg-gray-200 rounded"></div>
                            ))}
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Short Link</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Destination</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Clicks</th>
                                        <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Details</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {links && links.map((link, index) => (
                                        <tr key={index} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 text-sm text-blue-600">
                                                <a href={link.shortUrl} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                                    {link.id}
                                                </a>
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600 max-w-md truncate">
                                                {link.title || link.longUrl}
                                            </td>
                                            <td className="px-4 py-3 text-xs">
                                                {link.tags && link.tags.map((tag, i) => (
                                                    <span key={i} className="inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-1 mr-1 mb-1">
                                                        {tag}
                                                    </span>
                                                ))}
                                            </td>
                                            <td className="px-4 py-3 text-sm font-bold text-gray-900 text-right">
                                                {link.clicks.toLocaleString()}
                                            </td>
                                            <td className="px-4 py-3 text-center">
                                                <button
                                                    onClick={() => onViewDetails(link)}
                                                    className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-semibold transition-colors"
                                                >
                                                    <i className="fas fa-chart-line mr-1"></i>
                                                    View
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Main Dashboard
        const Dashboard = () => {
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [dateRange, setDateRange] = useState(30);
            const [showReferrerModal, setShowReferrerModal] = useState(false);
            const [selectedLink, setSelectedLink] = useState(null);
            
            // Data states
            const [leadStats, setLeadStats] = useState(null);
            const [bitlyData, setBitlyData] = useState(null);
            const [eventsData, setEventsData] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);

            const fetchAllData = async (refetchBitly = true) => {
                setLoading(true);
                setError(null);
                
                try {
                    const promises = [
                        callAPI('mailchimp', { action: 'getLeadStats', weeks: 12 }),
                        callAPI('ticket-tailor', { action: 'getEvents' })
                    ];

                    if (refetchBitly) {
                        promises.push(callAPI('bitly', { action: 'getRecruitmentLinks', days: dateRange }));
                    }

                    const results = await Promise.allSettled(promises);

                    if (results[0].status === 'fulfilled') {
                        setLeadStats(results[0].value);
                    } else {
                        console.error('Mailchimp error:', results[0].reason);
                    }

                    if (results[1].status === 'fulfilled') {
                        setEventsData(results[1].value);
                    } else {
                        console.error('Ticket Tailor error:', results[1].reason);
                    }

                    if (refetchBitly && results[2]) {
                        if (results[2].status === 'fulfilled') {
                            setBitlyData(results[2].value);
                        } else {
                            console.error('Bitly error:', results[2].reason);
                        }
                    }

                    setLastUpdated(new Date());
                } catch (err) {
                    setError('Failed to load dashboard data. Check your API configuration.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const refetchBitlyOnly = async () => {
                try {
                    const result = await callAPI('bitly', { action: 'getRecruitmentLinks', days: dateRange });
                    setBitlyData(result);
                    setLastUpdated(new Date());
                } catch (err) {
                    console.error('Bitly error:', err);
                }
            };

            useEffect(() => {
                fetchAllData();
            }, []);

            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="mb-8">
                            <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-4">
                                <div>
                                    <h1 className="text-4xl font-bold text-gray-900">
                                        <i className="fas fa-graduation-cap mr-3 text-blue-600"></i>
                                        Student Recruitment Dashboard
                                    </h1>
                                    <p className="text-gray-600 mt-2">
                                        Academic Year {new Date().getMonth() >= 8 ? new Date().getFullYear() : new Date().getFullYear() - 1}/{new Date().getMonth() >= 8 ? new Date().getFullYear() + 1 : new Date().getFullYear()}
                                    </p>
                                </div>
                                <div className="flex flex-wrap items-center gap-3">
                                    {/* Export CSV Button */}
                                    <button
                                        onClick={() => exportToCSV(bitlyData, eventsData, dateRange)}
                                        disabled={loading}
                                        className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors disabled:bg-gray-400 shadow-sm"
                                        title="Export data as CSV"
                                    >
                                        <i className="fas fa-file-csv mr-2"></i>
                                        Export CSV
                                    </button>

                                    {/* Refresh Button */}
                                    <button
                                        onClick={() => fetchAllData(true)}
                                        disabled={loading}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors disabled:bg-gray-400 shadow-sm"
                                    >
                                        <i className="fas fa-sync-alt mr-2"></i>
                                        Refresh All
                                    </button>
                                </div>
                            </div>
                            {lastUpdated && (
                                <p className="text-sm text-gray-500">
                                    <i className="fas fa-clock mr-1"></i>
                                    Last updated: {lastUpdated.toLocaleTimeString()}
                                </p>
                            )}
                        </div>

                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <KPICard
                                title="Total Leads"
                                value={leadStats?.leads?.toLocaleString() || '0'}
                                change={leadStats?.weeklyChange}
                                icon="fas fa-users"
                                color="bg-blue-600"
                                loading={loading}
                                subtitle={`${leadStats?.thisWeekSubscribed || 0} new this week`}
                            />
                            <KPICard
                                title="Applicants"
                                value={leadStats?.applicants?.toLocaleString() || '0'}
                                change={null}
                                icon="fas fa-user-graduate"
                                color="bg-green-600"
                                loading={loading}
                                subtitle={`${leadStats?.conversionRate || 0}% conversion rate`}
                            />
                            <KPICard
                                title={`Link Clicks (${dateRange}d)`}
                                value={bitlyData?.totalClicks?.toLocaleString() || '0'}
                                change={null}
                                icon="fas fa-mouse-pointer"
                                color="bg-purple-600"
                                loading={loading}
                                subtitle={`${bitlyData?.totalLinks || 0} active links`}
                            />
                            <KPICard
                                title="Upcoming Events"
                                value={eventsData?.upcomingEvents?.length || '0'}
                                change={null}
                                icon="fas fa-calendar-check"
                                color="bg-orange-600"
                                loading={loading}
                                subtitle={`${eventsData?.summary?.totalSold || 0} people attending`}
                            />
                        </div>

                        {/* Main Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <ChartComponent
                                title="Lead Generation Trend (Weekly)"
                                type="line"
                                data={leadStats?.weeklyData?.map(w => w.net) || []}
                                labels={leadStats?.weeklyData?.map(w => {
                                    const date = new Date(w.date);
                                    return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
                                }) || []}
                                loading={loading}
                            />
                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-gray-800">
                                        Traffic Sources (Top Referrers)
                                    </h3>
                                    <div className="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
                                        <i className="fas fa-calendar-alt text-blue-600 text-sm"></i>
                                        <select
                                            value={dateRange}
                                            onChange={(e) => {
                                                setDateRange(parseInt(e.target.value));
                                                setTimeout(() => refetchBitlyOnly(), 100);
                                            }}
                                            className="border-0 bg-transparent text-sm font-medium text-gray-700 focus:outline-none cursor-pointer"
                                        >
                                            <option value={7}>7 days</option>
                                            <option value={14}>14 days</option>
                                            <option value={30}>30 days</option>
                                            <option value={60}>60 days</option>
                                            <option value={90}>90 days</option>
                                        </select>
                                    </div>
                                </div>
                                {loading ? (
                                    <div className="animate-pulse" style={{ height: '300px' }}>
                                        <div className="h-full bg-gray-200 rounded"></div>
                                    </div>
                                ) : (
                                    <div style={{ height: '300px' }}>
                                        <canvas ref={(ref) => {
                                            if (ref && bitlyData?.topReferrers) {
                                                const ctx = ref.getContext('2d');
                                                new Chart(ctx, {
                                                    type: 'bar',
                                                    data: {
                                                        labels: bitlyData.topReferrers.map(r => r.referrer),
                                                        datasets: [{
                                                            label: 'Clicks',
                                                            data: bitlyData.topReferrers.map(r => r.clicks),
                                                            backgroundColor: [
                                                                'rgba(59, 130, 246, 0.8)',
                                                                'rgba(16, 185, 129, 0.8)',
                                                                'rgba(245, 158, 11, 0.8)',
                                                                'rgba(239, 68, 68, 0.8)',
                                                                'rgba(139, 92, 246, 0.8)',
                                                                'rgba(236, 72, 153, 0.8)',
                                                                'rgba(99, 102, 241, 0.8)',
                                                                'rgba(251, 146, 60, 0.8)'
                                                            ],
                                                            borderColor: 'rgba(59, 130, 246, 1)',
                                                            borderWidth: 2
                                                        }]
                                                    },
                                                    options: {
                                                        responsive: true,
                                                        maintainAspectRatio: false,
                                                        plugins: {
                                                            legend: { display: false }
                                                        },
                                                        scales: {
                                                            y: {
                                                                beginAtZero: true,
                                                                ticks: { precision: 0 }
                                                            }
                                                        }
                                                    }
                                                });
                                            }
                                        }}></canvas>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Geographic Distribution & Event Summary */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">
                                    <i className="fas fa-globe mr-2"></i>Geographic Distribution
                                </h3>
                                {loading ? (
                                    <div className="animate-pulse space-y-3">
                                        {[1,2,3,4,5].map(i => (
                                            <div key={i} className="h-10 bg-gray-200 rounded"></div>
                                        ))}
                                    </div>
                                ) : bitlyData?.topCountries && bitlyData.topCountries.length > 0 ? (
                                    <div className="space-y-3">
                                        {bitlyData.topCountries.map((country, index) => (
                                            <div 
                                                key={index} 
                                                className="flex items-center justify-between p-3 rounded-lg hover:bg-blue-50 transition-all duration-200 cursor-default group"
                                                title={getFullCountryName(country.country)}
                                            >
                                                <span className="font-semibold text-gray-800 group-hover:text-blue-700 transition-colors min-w-[120px]">
                                                    {getFullCountryName(country.country)}
                                                </span>
                                                <div className="flex items-center gap-4 flex-1 ml-4">
                                                    <div className="flex-1 max-w-md bg-gray-200 rounded-full h-3 overflow-hidden">
                                                        <div
                                                            className="bg-blue-600 h-3 rounded-full transition-all duration-500 group-hover:bg-blue-700"
                                                            style={{ width: `${country.percentage}%` }}
                                                        ></div>
                                                    </div>
                                                    <span className="font-bold text-gray-900 w-14 text-right">
                                                        {country.percentage}%
                                                    </span>
                                                    <span className="text-gray-700 font-semibold w-16 text-right">
                                                        {country.clicks.toLocaleString()}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500 text-center py-8">No geographic data available</p>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">
                                    <i className="fas fa-chart-pie mr-2"></i>Event Summary
                                </h3>
                                {loading ? (
                                    <div className="animate-pulse space-y-4">
                                        {[1,2].map(i => (
                                            <div key={i} className="h-12 bg-gray-200 rounded"></div>
                                        ))}
                                    </div>
                                ) : eventsData?.summary ? (
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center p-4 bg-blue-50 rounded-lg">
                                            <span className="text-gray-700 font-medium text-lg">Total Events</span>
                                            <span className="text-3xl font-bold text-blue-600">{eventsData.summary.totalEvents}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-4 bg-purple-50 rounded-lg">
                                            <span className="text-gray-700 font-medium text-lg">People Attending</span>
                                            <span className="text-3xl font-bold text-purple-600">{eventsData.summary.totalSold}</span>
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No event data available</p>
                                )}
                            </div>
                        </div>

                        {/* Events Table */}
                        <div className="mb-6">
                            <EventsTable events={eventsData?.upcomingEvents} loading={loading} />
                        </div>

                        {/* Links Table */}
                        <div className="mb-6">
                            <LinksTable 
                                links={bitlyData?.links} 
                                loading={loading}
                                onViewDetails={(link) => {
                                    setSelectedLink(link);
                                    setShowReferrerModal(true);
                                }}
                            />
                        </div>

                        {/* Footer */}
                        <div className="mt-8 text-center text-gray-500 text-sm border-t pt-6">
                            <p>Student Recruitment Dashboard â€¢ Academic Year 2024/25</p>
                            <p className="mt-1">Recruitment Period: October - August</p>
                        </div>
                    </div>

                    {/* Referrer Modal */}
                    {showReferrerModal && selectedLink && (
                        <ReferrerModal 
                            link={selectedLink} 
                            onClose={() => {
                                setShowReferrerModal(false);
                                setSelectedLink(null);
                            }}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
