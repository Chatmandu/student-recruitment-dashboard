<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Recruitment Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Helper
        const callAPI = async (endpoint, data) => {
            try {
                const response = await fetch(`/api/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                return await response.json();
            } catch (error) {
                console.error(`Error calling ${endpoint}:`, error);
                throw error;
            }
        };

        // KPI Card Component
        const KPICard = ({ title, value, change, icon, color, loading, subtitle }) => {
            const isPositive = change >= 0;
            return (
                <div className="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow">
                    <div className="flex items-center justify-between">
                        <div className="flex-1">
                            <p className="text-gray-500 text-sm font-medium uppercase tracking-wide">{title}</p>
                            {loading ? (
                                <div className="animate-pulse mt-2">
                                    <div className="h-8 bg-gray-200 rounded w-24"></div>
                                </div>
                            ) : (
                                <>
                                    <p className="text-3xl font-bold text-gray-900 mt-2">{value}</p>
                                    {subtitle && <p className="text-xs text-gray-500 mt-1">{subtitle}</p>}
                                    {change !== null && change !== undefined && (
                                        <p className={`text-sm mt-2 font-semibold ${isPositive ? 'text-green-600' : 'text-red-600'}`}>
                                            <i className={`fas fa-arrow-${isPositive ? 'up' : 'down'} mr-1`}></i>
                                            {Math.abs(change)}% vs last week
                                        </p>
                                    )}
                                </>
                            )}
                        </div>
                        <div className={`${color} p-4 rounded-full shadow-md`}>
                            <i className={`${icon} text-2xl text-white`}></i>
                        </div>
                    </div>
                </div>
            );
        };

        // Chart Component
        const ChartComponent = ({ title, type, data, labels, loading, height = 300 }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (chartRef.current && !loading && data && labels) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: type,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: title,
                                data: data,
                                backgroundColor: type === 'line' ? 'rgba(59, 130, 246, 0.1)' : [
                                    'rgba(59, 130, 246, 0.8)',
                                    'rgba(16, 185, 129, 0.8)',
                                    'rgba(245, 158, 11, 0.8)',
                                    'rgba(239, 68, 68, 0.8)',
                                    'rgba(139, 92, 246, 0.8)',
                                    'rgba(236, 72, 153, 0.8)',
                                    'rgba(99, 102, 241, 0.8)',
                                    'rgba(251, 146, 60, 0.8)'
                                ],
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2,
                                fill: type === 'line',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: type !== 'line',
                                    position: 'bottom'
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false
                                }
                            },
                            scales: type === 'line' || type === 'bar' ? {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        precision: 0
                                    }
                                }
                            } : {}
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data, labels, type, title, loading]);

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">{title}</h3>
                    {loading ? (
                        <div className="animate-pulse" style={{ height: `${height}px` }}>
                            <div className="h-full bg-gray-200 rounded"></div>
                        </div>
                    ) : (
                        <div style={{ height: `${height}px` }}>
                            <canvas ref={chartRef}></canvas>
                        </div>
                    )}
                </div>
            );
        };

        // Events Table Component
        const EventsTable = ({ events, loading }) => {
            const [sortField, setSortField] = useState('start');
            const [sortDirection, setSortDirection] = useState('asc');

            const sortedEvents = events ? [...events].sort((a, b) => {
                const aVal = a[sortField];
                const bVal = b[sortField];
                const modifier = sortDirection === 'asc' ? 1 : -1;
                return aVal > bVal ? modifier : -modifier;
            }) : [];

            const toggleSort = (field) => {
                if (sortField === field) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortField(field);
                    setSortDirection('asc');
                }
            };

            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">
                        <i className="fas fa-calendar-alt mr-2"></i>Upcoming Events
                    </h3>
                    {loading ? (
                        <div className="animate-pulse space-y-3">
                            {[1,2,3,4,5].map(i => (
                                <div key={i} className="h-16 bg-gray-200 rounded"></div>
                            ))}
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('start')}>
                                            Date {sortField === 'start' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('name')}>
                                            Event Name {sortField === 'name' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Venue</th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('capacity')}>
                                            Capacity {sortField === 'capacity' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('sold')}>
                                            Sold {sortField === 'sold' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Available</th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100"
                                            onClick={() => toggleSort('percentageSold')}>
                                            % Sold {sortField === 'percentageSold' && (
                                                <i className={`fas fa-chevron-${sortDirection === 'asc' ? 'up' : 'down'} ml-1`}></i>
                                            )}
                                        </th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {sortedEvents.map((event, index) => {
                                        const date = new Date(event.start);
                                        const percentage = parseFloat(event.percentageSold);
                                        const statusColor = percentage >= 90 ? 'text-red-600' : percentage >= 70 ? 'text-yellow-600' : 'text-green-600';
                                        
                                        return (
                                            <tr key={index} className="hover:bg-gray-50">
                                                <td className="px-4 py-3 text-sm text-gray-900 whitespace-nowrap">
                                                    {date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}
                                                </td>
                                                <td className="px-4 py-3 text-sm font-medium text-gray-900">
                                                    {event.name}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-600">
                                                    {event.venue || 'TBA'}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-900 text-right">
                                                    {event.capacity}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-900 text-right font-semibold">
                                                    {event.sold}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-600 text-right">
                                                    {event.available}
                                                </td>
                                                <td className={`px-4 py-3 text-sm text-right font-bold ${statusColor}`}>
                                                    {event.percentageSold}%
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Links Table Component
        const LinksTable = ({ links, loading }) => {
            return (
                <div className="bg-white p-6 rounded-lg shadow-md">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">
                        <i className="fas fa-link mr-2"></i>Student Recruitment Links
                    </h3>
                    {loading ? (
                        <div className="animate-pulse space-y-3">
                            {[1,2,3,4,5].map(i => (
                                <div key={i} className="h-12 bg-gray-200 rounded"></div>
                            ))}
                        </div>
                    ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Short Link</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Destination</th>
                                        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tags</th>
                                        <th className="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total Clicks</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {links && links.map((link, index) => (
                                        <tr key={index} className="hover:bg-gray-50">
                                            <td className="px-4 py-3 text-sm text-blue-600">
                                                <a href={link.shortUrl} target="_blank" rel="noopener noreferrer" className="hover:underline">
                                                    {link.id}
                                                </a>
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600 max-w-md truncate">
                                                {link.title || link.longUrl}
                                            </td>
                                            <td className="px-4 py-3 text-xs">
                                                {link.tags && link.tags.map((tag, i) => (
                                                    <span key={i} className="inline-block bg-blue-100 text-blue-800 rounded-full px-2 py-1 mr-1 mb-1">
                                                        {tag}
                                                    </span>
                                                ))}
                                            </td>
                                            <td className="px-4 py-3 text-sm font-bold text-gray-900 text-right">
                                                {link.clicks.toLocaleString()}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        // Main Dashboard
        const Dashboard = () => {
            const [loading, setLoading] = useState(true);
            const [autoRefresh, setAutoRefresh] = useState(false);
            const [error, setError] = useState(null);
            
            // Data states
            const [leadStats, setLeadStats] = useState(null);
            const [bitlyData, setBitlyData] = useState(null);
            const [eventsData, setEventsData] = useState(null);
            const [lastUpdated, setLastUpdated] = useState(null);

            const fetchAllData = async () => {
                setLoading(true);
                setError(null);
                
                try {
                    // Fetch all data in parallel
                    const [mailchimpRes, bitlyRes, ticketTailorRes] = await Promise.allSettled([
                        callAPI('mailchimp', { action: 'getLeadStats', weeks: 12 }),
                        callAPI('bitly', { action: 'getRecruitmentLinks', days: 30 }),
                        callAPI('ticket-tailor', { action: 'getEvents' })
                    ]);

                    if (mailchimpRes.status === 'fulfilled') {
                        setLeadStats(mailchimpRes.value);
                    } else {
                        console.error('Mailchimp error:', mailchimpRes.reason);
                    }

                    if (bitlyRes.status === 'fulfilled') {
                        setBitlyData(bitlyRes.value);
                    } else {
                        console.error('Bitly error:', bitlyRes.reason);
                    }

                    if (ticketTailorRes.status === 'fulfilled') {
                        setEventsData(ticketTailorRes.value);
                    } else {
                        console.error('Ticket Tailor error:', ticketTailorRes.reason);
                    }

                    setLastUpdated(new Date());
                } catch (err) {
                    setError('Failed to load dashboard data. Check your API configuration.');
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                fetchAllData();
            }, []);

            useEffect(() => {
                if (autoRefresh) {
                    const interval = setInterval(fetchAllData, 30000);
                    return () => clearInterval(interval);
                }
            }, [autoRefresh]);

            return (
                <div className="min-h-screen p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="mb-6 flex justify-between items-center">
                            <div>
                                <h1 className="text-4xl font-bold text-gray-900">
                                    <i className="fas fa-graduation-cap mr-3 text-blue-600"></i>
                                    Student Recruitment Dashboard
                                </h1>
                                <p className="text-gray-600 mt-2">
                                    Academic Year {new Date().getMonth() >= 8 ? new Date().getFullYear() : new Date().getFullYear() - 1}/{new Date().getMonth() >= 8 ? new Date().getFullYear() + 1 : new Date().getFullYear()}
                                </p>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <input
                                        type="checkbox"
                                        id="autoRefresh"
                                        checked={autoRefresh}
                                        onChange={(e) => setAutoRefresh(e.target.checked)}
                                        className="w-4 h-4"
                                    />
                                    <label htmlFor="autoRefresh" className="text-sm font-medium text-gray-700">
                                        Auto-refresh (30s)
                                    </label>
                                </div>
                                <button
                                    onClick={fetchAllData}
                                    className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition flex items-center gap-2"
                                >
                                    <i className="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                        </div>

                        {/* Error Message */}
                        {error && (
                            <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                                <div className="flex">
                                    <i className="fas fa-exclamation-circle text-red-500 mt-0.5 mr-3"></i>
                                    <p className="text-red-700">{error}</p>
                                </div>
                            </div>
                        )}

                        {/* Last Updated */}
                        {lastUpdated && (
                            <div className="text-right text-sm text-gray-500 mb-4">
                                Last updated: {lastUpdated.toLocaleString()}
                            </div>
                        )}

                        {/* KPI Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                            <KPICard
                                title="Total Leads"
                                value={leadStats?.leads?.toLocaleString() || '0'}
                                change={leadStats?.weeklyChange}
                                icon="fas fa-users"
                                color="bg-blue-600"
                                loading={loading}
                                subtitle={`${leadStats?.thisWeekSubscribed || 0} new this week`}
                            />
                            <KPICard
                                title="Applicants"
                                value={leadStats?.applicants?.toLocaleString() || '0'}
                                change={null}
                                icon="fas fa-user-graduate"
                                color="bg-green-600"
                                loading={loading}
                                subtitle={`${leadStats?.conversionRate || 0}% conversion rate`}
                            />
                            <KPICard
                                title="Link Clicks (30d)"
                                value={bitlyData?.totalClicks?.toLocaleString() || '0'}
                                change={null}
                                icon="fas fa-mouse-pointer"
                                color="bg-purple-600"
                                loading={loading}
                                subtitle={`${bitlyData?.totalLinks || 0} active links`}
                            />
                            <KPICard
                                title="Upcoming Events"
                                value={eventsData?.upcomingEvents?.length || '0'}
                                change={null}
                                icon="fas fa-calendar-check"
                                color="bg-orange-600"
                                loading={loading}
                                subtitle={`${eventsData?.summary?.totalSold || 0} tickets sold`}
                            />
                        </div>

                        {/* Main Charts */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <ChartComponent
                                title="Lead Generation Trend (Weekly)"
                                type="line"
                                data={leadStats?.weeklyData?.map(w => w.net) || []}
                                labels={leadStats?.weeklyData?.map(w => {
                                    const date = new Date(w.date);
                                    return date.toLocaleDateString('en-GB', { month: 'short', day: 'numeric' });
                                }) || []}
                                loading={loading}
                            />
                            <ChartComponent
                                title="Traffic Sources (Top Referrers)"
                                type="bar"
                                data={bitlyData?.topReferrers?.map(r => r.clicks) || []}
                                labels={bitlyData?.topReferrers?.map(r => r.referrer) || []}
                                loading={loading}
                            />
                        </div>

                        {/* Geographic Distribution */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">
                                    <i className="fas fa-globe mr-2"></i>Geographic Distribution
                                </h3>
                                {loading ? (
                                    <div className="animate-pulse space-y-3">
                                        {[1,2,3,4,5].map(i => (
                                            <div key={i} className="h-8 bg-gray-200 rounded"></div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="space-y-3">
                                        {bitlyData?.topCountries?.map((country, index) => (
                                            <div key={index} className="flex items-center justify-between">
                                                <span className="font-medium text-gray-700">{country.country}</span>
                                                <div className="flex items-center gap-4">
                                                    <div className="w-32 bg-gray-200 rounded-full h-2">
                                                        <div
                                                            className="bg-blue-600 h-2 rounded-full"
                                                            style={{ width: `${country.percentage}%` }}
                                                        ></div>
                                                    </div>
                                                    <span className="font-semibold text-gray-800 w-16 text-right">
                                                        {country.percentage}%
                                                    </span>
                                                    <span className="text-gray-600 w-16 text-right text-sm">
                                                        {country.clicks.toLocaleString()}
                                                    </span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h3 className="text-lg font-bold text-gray-800 mb-4">
                                    <i className="fas fa-chart-pie mr-2"></i>Event Summary
                                </h3>
                                {loading ? (
                                    <div className="animate-pulse space-y-4">
                                        {[1,2,3].map(i => (
                                            <div key={i} className="h-12 bg-gray-200 rounded"></div>
                                        ))}
                                    </div>
                                ) : eventsData?.summary ? (
                                    <div className="space-y-4">
                                        <div className="flex justify-between items-center p-3 bg-blue-50 rounded">
                                            <span className="text-gray-700 font-medium">Total Events</span>
                                            <span className="text-2xl font-bold text-blue-600">{eventsData.summary.totalEvents}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-green-50 rounded">
                                            <span className="text-gray-700 font-medium">Total Capacity</span>
                                            <span className="text-2xl font-bold text-green-600">{eventsData.summary.totalCapacity}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-purple-50 rounded">
                                            <span className="text-gray-700 font-medium">Tickets Sold</span>
                                            <span className="text-2xl font-bold text-purple-600">{eventsData.summary.totalSold}</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-orange-50 rounded">
                                            <span className="text-gray-700 font-medium">Capacity Utilization</span>
                                            <span className="text-2xl font-bold text-orange-600">{eventsData.summary.overallCapacityUtilization}%</span>
                                        </div>
                                        <div className="flex justify-between items-center p-3 bg-yellow-50 rounded">
                                            <span className="text-gray-700 font-medium">Attendance Rate</span>
                                            <span className="text-2xl font-bold text-yellow-600">{eventsData.summary.attendanceRate}%</span>
                                        </div>
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No event data available</p>
                                )}
                            </div>
                        </div>

                        {/* Events Table */}
                        <div className="mb-6">
                            <EventsTable events={eventsData?.upcomingEvents} loading={loading} />
                        </div>

                        {/* Links Table */}
                        <div className="mb-6">
                            <LinksTable links={bitlyData?.links} loading={loading} />
                        </div>

                        {/* Footer */}
                        <div className="mt-8 text-center text-gray-500 text-sm border-t pt-6">
                            <p>Student Recruitment Dashboard â€¢ Academic Year 2024/25</p>
                            <p className="mt-1">Recruitment Period: October - August</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Dashboard />, document.getElementById('root'));
    </script>
</body>
</html>
